test_that("mdri estimation works", {
  expect_equal(mdrical(data=excalibdata,
                       subid_var = "SubjectID",
                       time_var = "DaysSinceEDDI",
                       recency_cutoff_time = 730.5,
                       inclusion_time_threshold = 800,
                       functional_forms = c("logit_cubic"),
                       recency_rule = "binary_data",
                       recency_vars = "Recent",
                       n_bootstraps = 0,
                       plot = FALSE,
                       parallel = FALSE)$MDRI$PE, 235.8039)
  expect_equal(mdrical(data=excalibdata,
                       subid_var = "SubjectID",
                       time_var = "DaysSinceEDDI",
                       recency_cutoff_time = 730.5,
                       inclusion_time_threshold = 800,
                       functional_forms = c("cloglog_linear"),
                       recency_rule = "binary_data",
                       recency_vars = "Recent",
                       n_bootstraps = 0,
                       plot = FALSE,
                       parallel = FALSE)$MDRI$PE, 248.1445)
})

test_that("frr estimation works", {
  expect_equal(frrcal(data=excalibdata,
                      subid_var = "SubjectID",
                      time_var = "DaysSinceEDDI",
                      recency_cutoff_time = 730.5,
                      recency_rule = "independent_thresholds",
                      recency_vars = c("Result","VL"),
                      recency_params = c(10,0,1000,1),
                      alpha = 0.05)$FRRest, 0.03007519)
  expect_equal(frrcal(data=excalibdata,
                      subid_var = "SubjectID",
                      time_var = "DaysSinceEDDI",
                      recency_cutoff_time = 730.5,
                      recency_rule = "independent_thresholds",
                      recency_vars = c("Result","VL"),
                      recency_params = c(10,0,1000,1),
                      alpha = 0.05,
                      method = "probit")$ci_method, "probit")
  expect_equal(frrcal(data=excalibdata,
                      subid_var = "SubjectID",
                      time_var = "DaysSinceEDDI",
                      recency_cutoff_time = 730.5,
                      recency_rule = "independent_thresholds",
                      recency_vars = c("Result","VL"),
                      recency_params = c(10,0,1000,1),
                      alpha = 0.05,
                      method = "probit")$LB, 0.01460227)
  expect_equal(frrcal(data=excalibdata,
                      subid_var = "SubjectID",
                      time_var = "DaysSinceEDDI",
                      recency_cutoff_time = 730.5,
                      recency_rule = "independent_thresholds",
                      recency_vars = c("Result","VL"),
                      recency_params = c(10,0,1000,1),
                      alpha = 0.05,
                      method = "probit")$UB, 0.05720647)
})

test_that("incidence estimation works", {
  expect_equal(incprops(PrevH = 0.20, 
                        RSE_PrevH = 0.028, 
                        PrevR = 0.10, 
                        RSE_PrevR = 0.09,
                        Boot = FALSE, 
                        MDRI = 200, 
                        RSE_MDRI = 0.05,
                        FRR = 0.01, 
                        RSE_FRR = 0.2, 
                        BigT = 730.5, 
                        debug = FALSE)$Incidence.Statistics$Incidence, 
               0.04264836)
  expect_equal(incprops(PrevH = c(0.20,0.21,0.18), 
                        RSE_PrevH = c(0.028,0.03,0.022),
                        PrevR = c(0.10,0.13,0.12), 
                        RSE_PrevR = c(0.094,0.095,0.05),
                        Boot = FALSE, 
                        BMest = 'MDRI.FRR.indep',
                        MDRI = c(200,180,180), 
                        RSE_MDRI = c(0.05,0.07,0.06),
                        FRR = c(0.01,0.009,0.02), 
                        RSE_FRR = c(0.2,0.2,0.1), 
                        BigT = 730.5)$Incidence.Difference.Statistics$p.value,
               c(0.01491562,0.39928244,0.01491562,0.05327965,0.39928244,0.05327965))
  expect_equal(inccounts(N = 10000,
                             N_H = 1000,
                             N_testR = 990,
                             N_R = 99,
                             DE_H = 1.2,
                             DE_R = 1.2,
                             Boot = FALSE,
                             alpha = 0.05,
                             MDRI= 200,
                             RSE_MDRI = 0.1,
                             FRR = 0.01,
                             RSE_FRR = 0.25,
                             BigT = 730.5,
                             Covar_HR = 0,
                             debug = FALSE),
                   incprops(PrevH = 0.1, 
                            RSE_PrevH = 0.03286335,
                            PrevR = 0.1, 
                            RSE_PrevR = 0.1044466,
                            Boot = FALSE,
                            alpha = 0.05,
                            MDRI= 200,
                            RSE_MDRI = 0.1,
                            FRR = 0.01,
                            RSE_FRR = 0.25,
                            BigT = 730.5,
                            Covar_HR = 0,
                            debug = FALSE),
                   tolerance = 1e-07)
})